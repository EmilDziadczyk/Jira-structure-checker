<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Jira Project Overview</title>
    <style>
        /* Atlassian / Appfire BigPicture-inspired design tokens */
        :root {
            --ds-background-neutral: #F4F5F7;
            --ds-background-default: #FFFFFF;
            --ds-background-subtle: #FAFBFC;
            --ds-border: #DFE1E6;
            --ds-border-bold: #C1C7D0;
            --ds-text: #172B4D;
            --ds-text-subtle: #5E6C84;
            --ds-text-subtler: #97A0AF;
            --ds-link: #0052CC;
            --ds-link-hover: #0065FF;
            --ds-accent-blue-subtle: #DEEBFF;
            --ds-success: #00875A;
            --ds-danger: #DE350B;
            --ds-danger-subtle: #FFEBE6;
            --radius: 3px;
            --radius-lg: 6px;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
            margin: 0;
            padding: 24px;
            background: var(--ds-background-neutral);
            color: var(--ds-text);
            font-size: 14px;
            line-height: 1.5;
        }
        h1, h2, h3 {
            margin: 0 0 8px 0;
            font-weight: 600;
            color: var(--ds-text);
        }
        h1 { font-size: 24px; }
        h2 { font-size: 20px; margin-top: 24px; }
        h3 { font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--ds-text-subtle); }
        .card {
            background: var(--ds-background-default);
            border-radius: var(--radius-lg);
            padding: 24px;
            max-width: 1600px;
            margin: 0 auto;
            border: 1px solid var(--ds-border);
            box-shadow: 0 1px 2px rgba(9, 30, 66, 0.08);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
            font-size: 14px;
        }
        th, td {
            padding: 12px 16px;
            text-align: left;
            vertical-align: top;
            border-bottom: 1px solid var(--ds-border);
        }
        th {
            background: var(--ds-background-subtle);
            font-weight: 600;
            color: var(--ds-text-subtle);
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 24px;
            white-space: nowrap;
        }
        th:hover {
            background: var(--ds-border);
        }
        th.sortable::after {
            content: " ↕";
            position: absolute;
            right: 8px;
            color: var(--ds-text-subtler);
            font-size: 12px;
        }
        th.sort-asc::after {
            content: " ▲";
            color: var(--ds-link);
        }
        th.sort-desc::after {
            content: " ▼";
            color: var(--ds-link);
        }
        tbody tr:hover {
            background: var(--ds-background-neutral);
        }
        .badge {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 999px;
            background: var(--ds-accent-blue-subtle);
            color: var(--ds-link);
            font-size: 12px;
            font-weight: 500;
        }
        .total {
            font-weight: 600;
            margin: 8px 0 0 0;
            color: var(--ds-text-subtle);
        }
        .subtitle {
            color: var(--ds-text-subtle);
            margin: 0 0 8px 0;
        }
        .type-table-wrapper {
            margin-top: 16px;
        }
        .type-table-wrapper table th { background: var(--ds-background-subtle); }
        .columns {
            display: flex;
            gap: 16px;
            margin-top: 24px;
        }
        .column {
            flex: 1;
            min-width: 30%;
            background: var(--ds-background-subtle);
            border-radius: var(--radius);
            padding: 16px;
            border: 1px solid var(--ds-border);
            max-height: 560px;
            overflow-y: auto;
        }
        .column h3 {
            margin: 0 0 8px 0;
        }
        .column table th:first-child,
        .column table td:first-child {
            width: 140px;
            white-space: nowrap;
        }
        .created-date {
            color: var(--ds-text-subtle);
            font-size: 13px;
            white-space: nowrap;
        }
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(9, 30, 66, 0.54);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--ds-background-default);
            border-radius: var(--radius-lg);
            padding: 24px;
            max-width: 920px;
            max-height: 85vh;
            width: 90%;
            border: 1px solid var(--ds-border-bold);
            box-shadow: 0 8px 32px rgba(9, 30, 66, 0.25);
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--ds-border);
        }
        .modal-header h2 { margin: 0; font-size: 20px; }
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--ds-text-subtle);
            padding: 4px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius);
        }
        .modal-close:hover {
            background: var(--ds-background-neutral);
            color: var(--ds-text);
        }
        .modal-content { overflow-y: auto; flex: 1; }
        .modal-table { width: 100%; border-collapse: collapse; }
        .modal-table th {
            position: sticky;
            top: 0;
            background: var(--ds-background-subtle);
            padding: 12px 16px;
            border-bottom: 2px solid var(--ds-border);
            font-weight: 600;
            color: var(--ds-text-subtle);
            z-index: 10;
            cursor: pointer;
        }
        .modal-table th:hover { background: var(--ds-border); }
        .modal-table th.sortable::after { content: " ↕"; position: absolute; right: 8px; color: var(--ds-text-subtler); font-size: 12px; }
        .modal-table th.sort-asc::after { content: " ▲"; color: var(--ds-link); }
        .modal-table th.sort-desc::after { content: " ▼"; color: var(--ds-link); }
        .modal-filter {
            width: 100%;
            padding: 8px 12px;
            margin-bottom: 4px;
            border: 1px solid var(--ds-border);
            border-radius: var(--radius);
            font-size: 14px;
        }
        .modal-filter:focus {
            outline: none;
            border-color: var(--ds-link);
            box-shadow: 0 0 0 2px rgba(0, 82, 204, 0.2);
        }
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 8px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--ds-border);
        }
        .modal-table td { padding: 12px 16px; border-bottom: 1px solid var(--ds-border); }
        .modal-table tbody tr:hover { background: var(--ds-background-neutral); }
        .modal-table .issue-id {
            font-weight: 600;
            color: var(--ds-link);
            cursor: pointer;
            text-decoration: none;
        }
        .modal-table .issue-id:hover { color: var(--ds-link-hover); text-decoration: underline; }
        .unlinked-count.clickable { cursor: pointer; text-decoration: underline; }
        .unlinked-count.clickable:hover { color: var(--ds-danger) !important; }
        .issue-type-clickable {
            cursor: pointer;
            transition: background 0.15s ease;
        }
        .issue-type-clickable:hover {
            background: var(--ds-accent-blue-subtle);
            padding: 2px 6px;
            border-radius: var(--radius);
        }
        .loading { text-align: center; padding: 32px; color: var(--ds-text-subtle); }
        .link-danger { color: var(--ds-danger); font-weight: 600; text-decoration: underline; cursor: pointer; }
        .link-danger:hover { color: #BF2600; }
        .status-ok { color: var(--ds-success); }
    </style>
</head>
<body>
<div class="card">
    <h1>Jira project summary</h1>
    <p class="subtitle">
        Project: <strong>{{ project_name }}</strong>
    </p>
    <p class="total">Total issues in current data set: {{ total_issues }}</p>

    <div class="type-table-wrapper">
        <h2>Issues by type</h2>
        <table>
            <thead>
            <tr>
                <th>Issue type</th>
                <th>Total count</th>
                <th>Unlinked</th>
            </tr>
            </thead>
            <tbody>
            {% for issue_type, total_count, unlinked_count, expected_parent in type_counts %}
                <tr>
                    <td>
                        <span class="badge issue-type-clickable" 
                              style="cursor: pointer; text-decoration: underline;"
                              data-issue-type="{{ issue_type }}">
                            {{ issue_type }}
                        </span>
                    </td>
                    <td>{{ total_count }}</td>
                    <td>
                        {% if expected_parent %}
                            {% if unlinked_count > 0 %}
                                <span class="unlinked-count clickable" 
                                      style="color: #dc2626; font-weight: 600;" 
                                      data-issue-type="{{ issue_type }}"
                                      data-expected-parent="{{ expected_parent }}">
                                    {{ unlinked_count }}
                                </span>
                                <span style="color: #666; font-size: 0.85em;">(not linked to {{ expected_parent }})</span>
                            {% else %}
                                <span style="color: #16a34a;">✓ All linked</span>
                            {% endif %}
                        {% else %}
                            <span style="color: #999;">—</span>
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    {% if quality_analysis %}
    <div class="type-table-wrapper" style="margin-top: 2rem;">
        <h2>Data quality</h2>
        <table>
            <thead>
            <tr>
                <th>Analysis type</th>
                <th>Count</th>
                <th>%</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td>Issues with Start Date in the past (Status: OPEN)</td>
                <td>
                    {% if quality_analysis.past_start_open.count > 0 %}
                    <a href="/quality/past-start-open" class="link-danger">{{ quality_analysis.past_start_open.count }}</a>
                    {% else %}
                    <span class="status-ok">0</span>
                    {% endif %}
                </td>
                <td>{{ "%.1f"|format(quality_analysis.past_start_open.percentage) }}%</td>
            </tr>
            <tr>
                <td>Issues In Progress without Assignee</td>
                <td>
                    {% if quality_analysis.in_progress_no_assignee.count > 0 %}
                    <a href="/quality/in-progress-no-assignee" class="link-danger">{{ quality_analysis.in_progress_no_assignee.count }}</a>
                    {% else %}
                    <span class="status-ok">0</span>
                    {% endif %}
                </td>
                <td>{{ "%.1f"|format(quality_analysis.in_progress_no_assignee.percentage) }}%</td>
            </tr>
            <tr>
                <td>Epics, Initiatives, Stories with status Waiting for release</td>
                <td>
                    {% if quality_analysis.waiting_for_release.count > 0 %}
                    <a href="#" id="waitingForReleaseCount" class="link-danger">{{ quality_analysis.waiting_for_release.count }}</a>
                    {% else %}
                    <span class="status-ok">0</span>
                    {% endif %}
                </td>
                <td>{{ "%.1f"|format(quality_analysis.waiting_for_release.percentage) }}%</td>
            </tr>
            </tbody>
        </table>
    </div>
    {% endif %}

    <div class="columns">

        <!-- EPICS -->
        <div class="column">
            <h3>Epics ({{ epics|length }})</h3>
            <p style="font-size: 0.85em; color: #666; margin-top: 0;">Unlinked only</p>
            <table class="sortable-table" data-table-id="epics">
                <thead>
                <tr>
                    <th class="sortable" data-sort="id">ID</th>
                    <th class="sortable" data-sort="summary">Summary</th>
                    <th class="sortable" data-sort="created">Created</th>
                </tr>
                </thead>
                <tbody>
                {% for key, summary, created in epics %}
                    <tr>
                        <td data-sort-value="{{ key }}">{{ key }}</td>
                        <td data-sort-value="{{ summary|lower }}">{{ summary }}</td>
                        <td data-sort-value="{{ created }}"><span class="created-date">{{ created }}</span></td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- STORIES -->
        <div class="column">
            <h3>Stories ({{ stories|length }})</h3>
            <p style="font-size: 0.85em; color: #666; margin-top: 0;">Unlinked only</p>
            <table class="sortable-table" data-table-id="stories">
                <thead>
                <tr>
                    <th class="sortable" data-sort="id">ID</th>
                    <th class="sortable" data-sort="summary">Summary</th>
                    <th class="sortable" data-sort="created">Created</th>
                </tr>
                </thead>
                <tbody>
                {% for key, summary, created in stories %}
                    <tr>
                        <td data-sort-value="{{ key }}">{{ key }}</td>
                        <td data-sort-value="{{ summary|lower }}">{{ summary }}</td>
                        <td data-sort-value="{{ created }}"><span class="created-date">{{ created }}</span></td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- TASKS -->
        <div class="column">
            <h3>Tasks ({{ tasks|length }})</h3>
            <p style="font-size: 0.85em; color: #666; margin-top: 0;">Unlinked only</p>
            <table class="sortable-table" data-table-id="tasks">
                <thead>
                <tr>
                    <th class="sortable" data-sort="id">ID</th>
                    <th class="sortable" data-sort="summary">Summary</th>
                    <th class="sortable" data-sort="created">Created</th>
                </tr>
                </thead>
                <tbody>
                {% for key, summary, created in tasks %}
                    <tr>
                        <td data-sort-value="{{ key }}">{{ key }}</td>
                        <td data-sort-value="{{ summary|lower }}">{{ summary }}</td>
                        <td data-sort-value="{{ created }}"><span class="created-date">{{ created }}</span></td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

    </div>
</div>

<!-- Modal for unlinked issues -->
<div class="modal-overlay" id="unlinkedModal">
    <div class="modal">
        <div class="modal-header">
            <h2 id="modalTitle">Unlinked Issues</h2>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-content" id="modalContent">
            <div class="loading">Loading...</div>
        </div>
    </div>
</div>

<script>
const JIRA_URL = {% if jira_url %}{{ jira_url|tojson }}{% else %}null{% endif %};
(function() {
    // Table sort handler
    function sortTable(table, columnIndex, ascending) {
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        rows.sort((a, b) => {
            const aCell = a.cells[columnIndex];
            const bCell = b.cells[columnIndex];
            const aValue = aCell ? (aCell.getAttribute('data-sort-value') || aCell.textContent.trim()) : '';
            const bValue = bCell ? (bCell.getAttribute('data-sort-value') || bCell.textContent.trim()) : '';
            
            let aCompare = aValue;
            let bCompare = bValue;
            
            // If ID column, extract numeric part for sort (e.g. "ONE-123" -> 123)
            if (columnIndex === 0) {
                const aMatch = aValue.match(/-(\d+)$/);
                const bMatch = bValue.match(/-(\d+)$/);
                if (aMatch && bMatch) {
                    const aNum = parseInt(aMatch[1], 10);
                    const bNum = parseInt(bMatch[1], 10);
                    if (aNum !== bNum) {
                        return ascending ? aNum - bNum : bNum - aNum;
                    }
                }
            }
            
            // Text comparison (case-insensitive)
            if (typeof aCompare === 'string' && typeof bCompare === 'string') {
                aCompare = aCompare.toLowerCase();
                bCompare = bCompare.toLowerCase();
            }
            
            // Compare values
            if (aCompare < bCompare) {
                return ascending ? -1 : 1;
            }
            if (aCompare > bCompare) {
                return ascending ? 1 : -1;
            }
            return 0;
        });
        
        rows.forEach(row => tbody.removeChild(row));
        rows.forEach(row => tbody.appendChild(row));
    }
    
    function handleHeaderClick(event) {
        const th = event.target.closest('th.sortable');
        if (!th) return;
        
        const table = th.closest('table.sortable-table');
        if (!table) return;
        
        const columnIndex = Array.from(th.parentElement.children).indexOf(th);
        
        const isCurrentlyAsc = th.classList.contains('sort-asc');
        const isCurrentlyDesc = th.classList.contains('sort-desc');
        
        table.querySelectorAll('th.sortable').forEach(header => {
            header.classList.remove('sort-asc', 'sort-desc');
        });
        
        let isAscending;
        if (!isCurrentlyAsc && !isCurrentlyDesc) {
            isAscending = true;
        } else if (isCurrentlyAsc) {
            isAscending = false;
        } else {
            isAscending = true;
        }
        
        th.classList.add(isAscending ? 'sort-asc' : 'sort-desc');
        sortTable(table, columnIndex, isAscending);
    }
    
        document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('table.sortable-table').forEach(table => {
            table.querySelectorAll('th.sortable').forEach(th => {
                th.addEventListener('click', handleHeaderClick);
            });
        });
        
        document.querySelectorAll('.unlinked-count.clickable').forEach(element => {
            element.addEventListener('click', function() {
                const issueType = this.getAttribute('data-issue-type');
                const expectedParent = this.getAttribute('data-expected-parent');
                showUnlinkedIssues(issueType, expectedParent);
            });
        });
        
        document.querySelectorAll('.issue-type-clickable').forEach(element => {
            element.addEventListener('click', function() {
                const issueType = this.getAttribute('data-issue-type');
                showAllIssuesByType(issueType);
            });
        });
        
        const waitingLink = document.getElementById('waitingForReleaseCount');
        if (waitingLink) {
            waitingLink.addEventListener('click', function(e) {
                e.preventDefault();
                showWaitingForReleaseIssues();
            });
        }
    });
})();

// Modal handling
let modalIssuesData = [];
let modalCurrentSort = { column: null, ascending: true };

function showUnlinkedIssues(issueType, expectedParent) {
    const modal = document.getElementById('unlinkedModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalContent = document.getElementById('modalContent');
    
    modalTitle.textContent = `Unlinked ${issueType} Issues (should be linked to ${expectedParent})`;
    modalContent.innerHTML = '<div class="loading">Loading...</div>';
    modal.classList.add('active');
    modalCurrentSort = { column: null, ascending: true };
    
    fetch(`/api/unlinked/${encodeURIComponent(issueType)}`)
        .then(response => response.json())
        .then(data => {
            if (data.issues && data.issues.length > 0) {
                modalIssuesData = data.issues;
                renderModalTable(data.issues, data.count, issueType);
            } else {
                modalContent.innerHTML = '<div class="loading">No unlinked issues found.</div>';
            }
        })
        .catch(error => {
            console.error('Error loading unlinked issues:', error);
            modalContent.innerHTML = '<div class="loading" style="color: #dc2626;">Error loading issues. Please try again.</div>';
        });
}

function renderModalTable(issues, totalCount, issueType) {
    const modalContent = document.getElementById('modalContent');
    
    let html = `
        <p style="margin-bottom: 1rem; color: #666;">Found <strong>${totalCount}</strong> unlinked ${issueType.toLowerCase()} issue(s):</p>
        <div class="filter-row">
            <input type="text" class="modal-filter" id="filter-id" placeholder="Filter ID..." onkeyup="filterModalTable()">
            <input type="text" class="modal-filter" id="filter-summary" placeholder="Filter Summary..." onkeyup="filterModalTable()">
            <input type="text" class="modal-filter" id="filter-created" placeholder="Filter Created Date..." onkeyup="filterModalTable()">
            <input type="text" class="modal-filter" id="filter-creator" placeholder="Filter Creator..." onkeyup="filterModalTable()">
            <input type="text" class="modal-filter" id="filter-reporter" placeholder="Filter Reporter..." onkeyup="filterModalTable()">
        </div>
        <table class="modal-table" id="modalTable">
            <thead>
                <tr>
                    <th class="sortable" data-column="key" onclick="sortModalTable('key')">ID</th>
                    <th class="sortable" data-column="summary" onclick="sortModalTable('summary')">Summary</th>
                    <th class="sortable" data-column="created_date" onclick="sortModalTable('created_date')">Created Date</th>
                    <th class="sortable" data-column="creator_name" onclick="sortModalTable('creator_name')">Creator</th>
                    <th class="sortable" data-column="reporter_name" onclick="sortModalTable('reporter_name')">Reporter</th>
                </tr>
            </thead>
            <tbody id="modalTableBody">
    `;
    
    issues.forEach(issue => {
        const jiraLink = JIRA_URL ? `${JIRA_URL}/browse/${issue.key}` : '#';
        html += `
            <tr>
                <td data-value="${escapeHtml(issue.key)}">
                    <a href="${jiraLink}" target="_blank" class="issue-id" ${!JIRA_URL ? 'onclick="return false;"' : ''}>
                        ${escapeHtml(issue.key)}
                    </a>
                </td>
                <td data-value="${escapeHtml(issue.summary.toLowerCase())}">${escapeHtml(issue.summary)}</td>
                <td data-value="${issue.created_date}">${issue.created_date}</td>
                <td data-value="${escapeHtml(issue.creator_name.toLowerCase())}">${escapeHtml(issue.creator_name)}</td>
                <td data-value="${escapeHtml((issue.reporter_name || 'Unknown').toLowerCase())}">${escapeHtml(issue.reporter_name || 'Unknown')}</td>
            </tr>
        `;
    });
    
    html += `
            </tbody>
        </table>
        <p id="modalFilterCount" style="margin-top: 0.5rem; color: #666; font-size: 0.9rem;"></p>
    `;
    
    modalContent.innerHTML = html;
    // Poczekaj na renderowanie DOM
    setTimeout(() => {
        updateModalFilterCount();
    }, 0);
}

function showWaitingForReleaseIssues() {
    const modal = document.getElementById('unlinkedModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalContent = document.getElementById('modalContent');
    
    modalTitle.textContent = 'Obiekty (Epiki, Inicjatywy, Stories) ze statusem Waiting for release';
    modalContent.innerHTML = '<div class="loading">Loading...</div>';
    modal.classList.add('active');
    modalCurrentSort = { column: null, ascending: true };
    
    fetch('/api/quality/waiting-for-release')
        .then(response => response.json())
        .then(data => {
            if (data.issues && data.issues.length > 0) {
                modalIssuesData = data.issues;
                renderWaitingForReleaseTable(data.issues);
            } else {
                modalContent.innerHTML = '<div class="loading">Brak obiektów ze statusem Waiting for release.</div>';
            }
        })
        .catch(error => {
            console.error('Error loading waiting-for-release:', error);
            modalContent.innerHTML = '<div class="loading" style="color: #dc2626;">Błąd ładowania. Spróbuj ponownie.</div>';
        });
}

function renderWaitingForReleaseTable(issues) {
    const modalContent = document.getElementById('modalContent');
    
    let html = `
        <p style="margin-bottom: 1rem; color: #666;">Znaleziono <strong>${issues.length}</strong> obiekt(ów) ze statusem Waiting for release:</p>
        <div class="filter-row">
            <input type="text" class="modal-filter" id="filter-id" placeholder="Filter ID..." onkeyup="filterModalTable()">
            <input type="text" class="modal-filter" id="filter-type" placeholder="Filter Typ..." onkeyup="filterModalTable()">
            <input type="text" class="modal-filter" id="filter-summary" placeholder="Filter Summary..." onkeyup="filterModalTable()">
            <input type="text" class="modal-filter" id="filter-status-since" placeholder="Filter Od kiedy..." onkeyup="filterModalTable()">
            <input type="text" class="modal-filter" id="filter-days" placeholder="Filter Dni..." onkeyup="filterModalTable()">
        </div>
        <table class="modal-table" id="modalTable">
            <thead>
                <tr>
                    <th class="sortable" data-column="key" onclick="sortModalTable('key')">ID</th>
                    <th class="sortable" data-column="issue_type" onclick="sortModalTable('issue_type')">Typ</th>
                    <th class="sortable" data-column="summary" onclick="sortModalTable('summary')">Summary</th>
                    <th class="sortable" data-column="status_since" onclick="sortModalTable('status_since')">Od kiedy</th>
                    <th class="sortable" data-column="days_in_status" onclick="sortModalTable('days_in_status')">Dni w statusie</th>
                </tr>
            </thead>
            <tbody id="modalTableBody">
    `;
    
    issues.forEach(issue => {
        const jiraLink = JIRA_URL ? `${JIRA_URL}/browse/${issue.key}` : '#';
        const statusSince = issue.status_since != null && issue.status_since !== '' ? issue.status_since : '—';
        const daysInStatus = issue.days_in_status != null && issue.days_in_status !== '' ? Number(issue.days_in_status) : null;
        const daysDisplay = daysInStatus !== null ? String(daysInStatus) : '—';
        const daysSortValue = daysInStatus !== null ? String(daysInStatus).padStart(8, '0') : '99999999';
        html += `
            <tr>
                <td data-value="${escapeHtml(issue.key)}">
                    <a href="${jiraLink}" target="_blank" class="issue-id" ${!JIRA_URL ? 'onclick="return false;"' : ''}>
                        ${escapeHtml(issue.key)}
                    </a>
                </td>
                <td data-value="${escapeHtml((issue.issue_type || '').toLowerCase())}">${escapeHtml(issue.issue_type || '')}</td>
                <td data-value="${escapeHtml((issue.summary || '').toLowerCase())}">${escapeHtml(issue.summary || '')}</td>
                <td data-value="${escapeHtml(String(statusSince).toLowerCase())}">${escapeHtml(statusSince)}</td>
                <td data-value="${daysSortValue}">${escapeHtml(daysDisplay)}</td>
            </tr>
        `;
    });
    
    html += `
            </tbody>
        </table>
        <p id="modalFilterCount" style="margin-top: 0.5rem; color: #666; font-size: 0.9rem;"></p>
    `;
    
    modalContent.innerHTML = html;
    setTimeout(() => updateModalFilterCount(), 0);
}

function filterModalTable() {
    const tbody = document.getElementById('modalTableBody');
    if (!tbody) return;
    
    const filterInputs = document.querySelectorAll('.modal-content .modal-filter');
    const rows = tbody.querySelectorAll('tr');
    const colCount = rows.length ? rows[0].querySelectorAll('td').length : 0;
    let visibleCount = 0;
    
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        let allMatch = true;
        for (let i = 0; i < colCount && i < filterInputs.length; i++) {
            const filterVal = (filterInputs[i]?.value || '').toLowerCase();
            const cellVal = (cells[i]?.getAttribute('data-value') || cells[i]?.textContent || '').toLowerCase();
            if (filterVal && !cellVal.includes(filterVal)) {
                allMatch = false;
                break;
            }
        }
        if (allMatch) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    updateModalFilterCount(visibleCount);
}

function sortModalTable(column) {
    const tbody = document.getElementById('modalTableBody');
    const table = document.getElementById('modalTable');
    if (!tbody || !table) return;
    
    const header = table.querySelector(`th[data-column="${column}"]`);
    const headerIndex = header ? Array.from(table.querySelectorAll('thead th')).indexOf(header) : 0;
    
    document.querySelectorAll('#modalTable th.sortable').forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
    });
    
    const isAscending = modalCurrentSort.column === column ? !modalCurrentSort.ascending : true;
    modalCurrentSort = { column, ascending: isAscending };
    if (header) header.classList.add(isAscending ? 'sort-asc' : 'sort-desc');
    
    const rows = Array.from(tbody.querySelectorAll('tr'));
    rows.sort((a, b) => {
        const cellsA = a.querySelectorAll('td');
        const cellsB = b.querySelectorAll('td');
        const valueA = cellsA[headerIndex]?.getAttribute('data-value') || cellsA[headerIndex]?.textContent.trim() || '';
        const valueB = cellsB[headerIndex]?.getAttribute('data-value') || cellsB[headerIndex]?.textContent.trim() || '';
        
        if (column === 'key') {
            const matchA = valueA.match(/-(\d+)$/);
            const matchB = valueB.match(/-(\d+)$/);
            if (matchA && matchB) {
                const numA = parseInt(matchA[1], 10);
                const numB = parseInt(matchB[1], 10);
                if (numA !== numB) return isAscending ? numA - numB : numB - numA;
            }
        }
        
        const compareA = valueA.toLowerCase();
        const compareB = valueB.toLowerCase();
        if (compareA < compareB) return isAscending ? -1 : 1;
        if (compareA > compareB) return isAscending ? 1 : -1;
        return 0;
    });
    
    rows.forEach(row => tbody.removeChild(row));
    rows.forEach(row => tbody.appendChild(row));
    
    const filterInputs = document.querySelectorAll('.modal-content .modal-filter');
    const colCount = rows[0] ? rows[0].querySelectorAll('td').length : 0;
    let visibleCount = 0;
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        let allMatch = true;
        for (let i = 0; i < colCount && i < filterInputs.length; i++) {
            const filterVal = (filterInputs[i]?.value || '').toLowerCase();
            const cellVal = (cells[i]?.getAttribute('data-value') || cells[i]?.textContent || '').toLowerCase();
            if (filterVal && !cellVal.includes(filterVal)) { allMatch = false; break; }
        }
        row.style.display = allMatch ? '' : 'none';
        if (allMatch) visibleCount++;
    });
    updateModalFilterCount(visibleCount);
}

function updateModalFilterCount(visibleCount) {
    const countElement = document.getElementById('modalFilterCount');
    if (!countElement) return;
    
    const tbody = document.getElementById('modalTableBody');
    if (!tbody) return;
    
    const totalCount = tbody.querySelectorAll('tr').length;
    let shownCount = visibleCount;
    
    // Jeśli visibleCount nie został podany, policz widoczne wiersze
    if (shownCount === undefined) {
        shownCount = Array.from(tbody.querySelectorAll('tr')).filter(row => row.style.display !== 'none').length;
    }
    
    if (shownCount === totalCount) {
        countElement.textContent = `Showing all ${totalCount} issue(s)`;
    } else {
        countElement.textContent = `Showing ${shownCount} of ${totalCount} issue(s)`;
    }
}

function showAllIssuesByType(issueType) {
    const modal = document.getElementById('unlinkedModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalContent = document.getElementById('modalContent');
    
    modalTitle.textContent = `All ${issueType} Issues`;
    modalContent.innerHTML = '<div class="loading">Loading...</div>';
    modal.classList.add('active');
    
    // Pobierz dane z API
    fetch(`/api/all/${encodeURIComponent(issueType)}`)
        .then(response => response.json())
        .then(data => {
            if (data.issues && data.issues.length > 0) {
                let html = `
                    <p style="margin-bottom: 1rem; color: #666;">Found <strong>${data.count}</strong> ${issueType.toLowerCase()} issue(s):</p>
                    <table class="modal-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Summary</th>
                                <th>Created Date</th>
                                <th>Creator</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                data.issues.forEach(issue => {
                    const jiraLink = JIRA_URL ? `${JIRA_URL}/browse/${issue.key}` : '#';
                    const statusBadge = issue.has_parent 
                        ? '<span style="color: #16a34a;">✓ Linked</span>' 
                        : '<span style="color: #dc2626;">✗ Unlinked</span>';
                    
                    html += `
                        <tr>
                            <td>
                                <a href="${jiraLink}" target="_blank" class="issue-id" ${!JIRA_URL ? 'onclick="return false;"' : ''}>
                                    ${issue.key}
                                </a>
                            </td>
                            <td>${escapeHtml(issue.summary)}</td>
                            <td>${issue.created_date}</td>
                            <td>${escapeHtml(issue.creator_name)}</td>
                            <td>${statusBadge}</td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
                
                modalContent.innerHTML = html;
            } else {
                modalContent.innerHTML = '<div class="loading">No issues found.</div>';
            }
        })
        .catch(error => {
            console.error('Error loading issues:', error);
            modalContent.innerHTML = '<div class="loading" style="color: #dc2626;">Error loading issues. Please try again.</div>';
        });
}

function closeModal() {
    const modal = document.getElementById('unlinkedModal');
    modal.classList.remove('active');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Zamknij modal po kliknięciu w overlay
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('unlinkedModal');
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeModal();
        }
    });
    
    // Zamknij modal po naciśnięciu ESC
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
            closeModal();
        }
    });
});
</script>
</body>
</html>
